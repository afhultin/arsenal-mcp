"""Metasploit tool wrappers â€” search, run modules, generate payloads."""
from __future__ import annotations
from typing import Any
from arsenal.tools.base import KaliTool, ExecutionMode


class MsfSearchTool(KaliTool):
    name = "msf_search"
    binary_name = "msfconsole"
    category = "exploit"
    description = "Search Metasploit modules by keyword or type"

    def build_command(self, target: str, **kwargs: Any) -> list[str]:
        query = target
        if module_type := kwargs.get("module_type", ""):
            query = f"type:{module_type} {query}"
        return [self.binary_name, "-q", "-x", f"search {query}; exit"]

    def parse_output(self, stdout: str, stderr: str) -> Any:
        modules = []
        for line in stdout.splitlines():
            line = line.strip()
            if line and ("exploit/" in line or "auxiliary/" in line or "post/" in line or "payload/" in line):
                parts = line.split()
                if len(parts) >= 3:
                    modules.append({"index": parts[0], "name": parts[1], "info": " ".join(parts[2:])})
        return {"modules": modules, "count": len(modules)}


class MsfRunTool(KaliTool):
    name = "msf_run"
    binary_name = "msfconsole"
    category = "exploit"
    description = "Run a Metasploit module with specified options"
    execution_mode = ExecutionMode.BACKGROUND

    def build_command(self, target: str, **kwargs: Any) -> list[str]:
        module_path = kwargs.get("module_path", target)
        commands = [f"use {module_path}"]
        options = kwargs.get("options", {})
        if isinstance(options, dict):
            for key, val in options.items():
                commands.append(f"set {key} {val}")
        if payload := kwargs.get("payload", ""):
            commands.append(f"set PAYLOAD {payload}")
        commands.append("run")
        commands.append("exit")
        cmd_str = "; ".join(commands)
        return [self.binary_name, "-q", "-x", cmd_str]

    def parse_output(self, stdout: str, stderr: str) -> Any:
        sessions = []
        for line in stdout.splitlines():
            if "session" in line.lower() and "opened" in line.lower():
                sessions.append(line.strip())
        return {"raw": stdout, "sessions_opened": sessions}


class MsfVenomTool(KaliTool):
    name = "msfvenom_generate"
    binary_name = "msfvenom"
    category = "exploit"
    description = "Generate Metasploit payloads and shellcode"

    def build_command(self, target: str, **kwargs: Any) -> list[str]:
        payload = kwargs.get("payload", target)
        cmd = [self.binary_name, "-p", payload]
        if lhost := kwargs.get("lhost", ""):
            cmd.append(f"LHOST={lhost}")
        if lport := kwargs.get("lport", ""):
            cmd.append(f"LPORT={lport}")
        if fmt := kwargs.get("format", ""):
            cmd.extend(["-f", fmt])
        if encoder := kwargs.get("encoder", ""):
            cmd.extend(["-e", encoder])
        if iterations := kwargs.get("iterations", ""):
            cmd.extend(["-i", str(iterations)])
        if output := kwargs.get("output", ""):
            cmd.extend(["-o", output])
        return cmd

    def parse_output(self, stdout: str, stderr: str) -> Any:
        return {"raw": stdout, "size": len(stdout)}
