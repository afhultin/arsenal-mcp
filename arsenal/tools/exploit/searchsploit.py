"""SearchSploit tool wrapper."""
from __future__ import annotations
import json
from typing import Any
from arsenal.tools.base import KaliTool


class SearchsploitTool(KaliTool):
    name = "searchsploit_search"
    binary_name = "searchsploit"
    category = "exploit"
    description = "Search Exploit-DB for public exploits and shellcodes"

    def build_command(self, target: str, **kwargs: Any) -> list[str]:
        cmd = [self.binary_name]
        if kwargs.get("json", True):
            cmd.append("--json")
        if kwargs.get("exact", False):
            cmd.append("--exact")
        if kwargs.get("www", False):
            cmd.append("--www")
        cmd.append(target)
        return cmd

    def parse_output(self, stdout: str, stderr: str) -> Any:
        try:
            data = json.loads(stdout)
            exploits = []
            for item in data.get("RESULTS_EXPLOIT", []):
                exploits.append({
                    "title": item.get("Title", ""),
                    "edb_id": item.get("EDB-ID", ""),
                    "path": item.get("Path", ""),
                    "platform": item.get("Platform", ""),
                    "type": item.get("Type", ""),
                })
            return {"exploits": exploits, "count": len(exploits)}
        except json.JSONDecodeError:
            lines = [line.strip() for line in stdout.splitlines() if line.strip() and not line.startswith("-")]
            return {"results": lines, "count": len(lines)}
