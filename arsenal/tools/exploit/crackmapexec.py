"""CrackMapExec tool wrapper."""
from __future__ import annotations
from typing import Any
from arsenal.tools.base import KaliTool


class CrackMapExecTool(KaliTool):
    name = "crackmapexec_scan"
    binary_name = "crackmapexec"
    category = "exploit"
    description = "Network authentication and exploitation tool for Active Directory"

    def build_command(self, target: str, **kwargs: Any) -> list[str]:
        protocol = kwargs.get("protocol", "smb")
        cmd = [self.binary_name, protocol, target]
        if username := kwargs.get("username", ""):
            cmd.extend(["-u", username])
        if password := kwargs.get("password", ""):
            cmd.extend(["-p", password])
        if domain := kwargs.get("domain", ""):
            cmd.extend(["-d", domain])
        if kwargs.get("sam", False):
            cmd.append("--sam")
        if kwargs.get("shares", False):
            cmd.append("--shares")
        if module := kwargs.get("module", ""):
            cmd.extend(["-M", module])
        return cmd

    def parse_output(self, stdout: str, stderr: str) -> Any:
        results = []
        findings = []
        for line in stdout.splitlines():
            line = line.strip()
            if not line:
                continue
            results.append(line)
            if "[+]" in line or "Pwn3d!" in line:
                findings.append({
                    "title": "Successful authentication or exploitation",
                    "severity": "high",
                    "finding_type": "credential",
                    "evidence": line,
                })
        return {"results": results, "count": len(results), "findings": findings}
